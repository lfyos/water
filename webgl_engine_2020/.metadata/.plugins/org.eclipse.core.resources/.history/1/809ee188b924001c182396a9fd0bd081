package kernel_engine;

import java.io.File;

import kernel_render.render;
import kernel_part.part;
import kernel_common_class.debug_information;
import kernel_common_class.sorter;
import kernel_file_manager.file_directory;
import kernel_file_manager.file_reader;
import kernel_file_manager.file_writer;
import kernel_interface.client_process_bar;

public class engine_boftal_creator extends sorter <part,String>
{
	private system_parameter system_par;
	private scene_parameter scene_par;
	
	public int compare_data(part s,part t)
	{
		String dir_s=file_directory.part_file_directory(s,system_par,scene_par);
		String dir_t=file_directory.part_file_directory(t,system_par,scene_par);
		return dir_s.compareTo(dir_t);
	}
	public int compare_key(part s,String t)
	{
		String dir_s=file_directory.part_file_directory(s,system_par,scene_par);
		return dir_s.compareTo(t);
	}
	public engine_boftal_creator(String file_name,String file_charset,part part_array[],
		system_parameter my_system_par,scene_parameter my_scene_par,client_process_bar process_bar)
	{
		int number=part_array.length;
		system_par=my_system_par;
		scene_par=my_scene_par;
		data_array=new part[number];
		
		long last_time=0;
		for(int i=0;i<number;i++) {
			long my_last_time=part_array[i].boftal.buffer_object_head_last_modify_time;
			if(last_time<my_last_time)
				last_time=my_last_time;
			data_array[i]=part_array[i];
		}
		if(new File(file_name).lastModified()>last_time)
			return;
		
		do_sort(-1,new part[number]);

		process_bar.set_process_bar(true, "create_buffer_object_file", 0,number);

		int cut_directory_length=system_par.proxy_par.proxy_data_root_directory_name.length();
		file_writer fw=new  file_writer(file_name,file_charset);
		fw.println(number);
		
		for(int i=0;i<number;i++) {
			process_bar.set_process_bar(false, "create_buffer_object_file", i, number);

			String part_temporary_file_directory=file_directory.part_file_directory(data_array[i],system_par,scene_par);
			String boftal_file_name=part_temporary_file_directory+"mesh.boftal";
			fw.println(part_temporary_file_directory.substring(cut_directory_length));

			file_reader fr=new file_reader(boftal_file_name,fw.get_charset());
			for(String str;!(fr.eof());)
				if((str=fr.get_string())!=null)
					fw.println(str);
			fr.close();
			fw.println();
		}
		fw.close();
		
		process_bar.set_process_bar(false, "create_buffer_object_file",number,number);
		
		debug_information.println("Create engine boftal file: finished");
	}
}
