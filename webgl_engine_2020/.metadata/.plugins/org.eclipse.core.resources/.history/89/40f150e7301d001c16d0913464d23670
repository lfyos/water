package kernel_part;

import java.io.File;
import java.util.concurrent.locks.ReentrantLock;

import kernel_common_class.debug_information;
import kernel_common_class.exclusive_file_mutex;
import kernel_engine.system_parameter;
import kernel_file_manager.file_directory;
import kernel_file_manager.file_reader;
import kernel_engine.scene_parameter;

public class part_loader_container
{
	private volatile part_loader part_loader_array[];
	private ReentrantLock part_loader_container_lock;
	
	public void destroy()
	{
		if(part_loader_array!=null) {
			for(int i=0,ni=part_loader_array.length;i<ni;i++)
				if(part_loader_array[i]!=null) {
					part_loader_array[i].destroy();
					part_loader_array[i]=null;
				}
			part_loader_array=null;
		}
		if(part_loader_container_lock!=null)
			part_loader_container_lock=null;
	}
	public part_loader_container()
	{
		part_loader_array=new part_loader[]{};
		part_loader_container_lock=new ReentrantLock();
	}
	private static void wait_for_part_loader_termination(part_loader pl,
			boolean display_flag,system_parameter system_par,scene_parameter scene_par)
	{
		if(display_flag) {
			debug_information.println("Begin:\twait_for_completion:\t",pl.loaded_part.system_name);
			debug_information.println("		",pl.loaded_part.directory_name+pl.loaded_part.mesh_file_name);
			debug_information.println("		",pl.loaded_part.directory_name+pl.loaded_part.material_file_name);
			debug_information.println("		",file_directory.part_file_directory(pl.loaded_part, system_par, scene_par));
		}
		try{			
			pl.join();
		}catch(Exception e){
			debug_information.println(e.toString());
			debug_information.println("Error:\twait_for_completion:\t"+pl.loaded_part.system_name);
			debug_information.println("		",pl.loaded_part.directory_name+pl.loaded_part.mesh_file_name);
			debug_information.println("		",pl.loaded_part.directory_name+pl.loaded_part.material_file_name);
			debug_information.println("		",file_directory.part_file_directory(pl.loaded_part,system_par, scene_par));
			e.printStackTrace();
		}
		if(display_flag)
			if(!(pl.test_loading_flag())) {
				debug_information.println("End:\twait_for_completion:\t"+pl.loaded_part.system_name);
				debug_information.println("		",pl.loaded_part.directory_name+pl.loaded_part.mesh_file_name);
				debug_information.println("		",pl.loaded_part.directory_name+pl.loaded_part.material_file_name);
				debug_information.println("		",file_directory.part_file_directory(pl.loaded_part,system_par, scene_par));
			}
	}
	public static void wait_for_completion(part_loader already_loaded_part[],
			system_parameter system_par,scene_parameter scene_par)
	{
		debug_information.println();
		debug_information.println("Begin wait_for_completion");
		debug_information.println();
		for(int wait_number=0;;wait_number++){
			int number=0;
			for(int i=0,ni=already_loaded_part.length;i<ni;i++){
				if(already_loaded_part[i]!=null){
					if(already_loaded_part[i].test_loading_flag()){
						if(number==i)
							number++;
						else {
							already_loaded_part[number++]=already_loaded_part[i];
							already_loaded_part[i]=null;
						}
					}else{
						wait_for_part_loader_termination(already_loaded_part[i],false,system_par,scene_par);
						already_loaded_part[i]=null;
					}	
				}
			}
			if(number<=0)
				break;
			for(int i=0;i<number;i++)
				if(already_loaded_part[i].test_loading_flag()){
					String str=already_loaded_part[i].loaded_part.system_name;
					debug_information.println(str+" is Waiting for completion:",wait_number);
					wait_for_part_loader_termination(already_loaded_part[i],true,system_par,scene_par);
					break;
				}
		}
		debug_information.println();
		debug_information.println("End wait_for_completion");
		debug_information.println();
	}
	private part_loader[] load_routine(part my_part,part my_copy_from_part,
			long last_modified_time,system_parameter system_par,scene_parameter scene_par,
			part_loader already_loaded_part[],part_container_for_part_search pcps,
			buffer_object_file_modify_time_and_length_container boftal_container)
	{
		int max_part_load_thread_number=my_part.part_par.max_part_load_thread_number;
		if(max_part_load_thread_number<1)
			max_part_load_thread_number=1;
		
		if(part_loader_array.length<max_part_load_thread_number){
			part_loader bak[]=part_loader_array;
			part_loader_array=new part_loader[max_part_load_thread_number];
			for(int i=0,ni=bak.length;i<ni;i++)
				part_loader_array[i]=bak[i];
			for(int i=bak.length,ni=part_loader_array.length;i<ni;i++)
				part_loader_array[i]=null;
		}
		for(long last_display_time=0;;){
			int number=0;
			for(int i=0,ni=part_loader_array.length;i<ni;i++){
				if(part_loader_array[i]!=null){
					if(part_loader_array[i].test_loading_flag()){
						if((number++)!=i){
							part_loader_array[number-1]=part_loader_array[i];
							part_loader_array[i]=null;
						}
					}else{
						wait_for_part_loader_termination(part_loader_array[i],false,system_par,scene_par);
						part_loader_array[i]=null;
					}
				}
			}
			long current_display_time=System.nanoTime()/(1000*1000*1000);
			if(number<max_part_load_thread_number)
				last_display_time=current_display_time;
			else{
				if((current_display_time-last_display_time)>5){
					last_display_time=current_display_time;
					debug_information.print  ("Current part loading number is ",	number);
					debug_information.println(", Maximum part loading number is ",	max_part_load_thread_number);				
				}
				try {
					long my_sleep_time_length=100/max_part_load_thread_number;
					Thread.sleep((my_sleep_time_length>100)?100:(my_sleep_time_length<=10)?10:my_sleep_time_length);
				}catch(Exception e) {
					Thread.yield();
				}
				continue;
			}
			part_loader my_loader=new part_loader(my_part,my_copy_from_part,
					last_modified_time,system_par,scene_par,pcps,boftal_container);
			part_loader_array[number++]=my_loader;
				
			for(int i=0,ni=already_loaded_part.length;i<ni;i++){
				if(already_loaded_part[i]==null){
					already_loaded_part[i]=my_loader;
					return already_loaded_part;
				}
				if(!(already_loaded_part[i].test_loading_flag())) {
					wait_for_part_loader_termination(already_loaded_part[i],false,system_par,scene_par);
					already_loaded_part[i]=my_loader;
					return already_loaded_part;
				}
			}
			part_loader bak[]=already_loaded_part;
			already_loaded_part=new part_loader[bak.length+1];
			for(int i=0,ni=bak.length;i<ni;i++)
				already_loaded_part[i]=bak[i];
			already_loaded_part[already_loaded_part.length-1]=my_loader;
			return already_loaded_part;
		}
	}
	
	public part_loader[] load(part my_part,part my_copy_from_part,
			long last_modified_time,system_parameter system_par,scene_parameter scene_par,
			part_loader already_loaded_part[],part_container_for_part_search pcps,
			buffer_object_file_modify_time_and_length_container boftal_container)
	{
		if(my_part.part_par.fast_load_flag) {
			String part_temporary_file_directory=file_directory.part_file_directory(my_part,system_par,scene_par);
			buffer_object_file_modify_time_and_length my_boftal;
			if((my_boftal=boftal_container.search_boftal(part_temporary_file_directory))!=null) {
				if(my_part.part_mesh==null)
					my_part.part_mesh=my_boftal.simple_part_mesh;
				my_part.boftal=my_boftal;
				my_part.part_mesh.free_memory();
				return already_loaded_part;
			};
		}
		
		String part_temporary_file_directory=file_directory.part_file_directory(my_part,system_par,scene_par);
		String lock_file_name=file_reader.separator(part_temporary_file_directory+"part.lock");
		String buffer_object_head_gzip_file_name=part_temporary_file_directory+"mesh.head.gzip_text";
		String cfp_mesh_file_name=my_copy_from_part.directory_name+my_copy_from_part.mesh_file_name;
		String cfp_material_file_name=my_copy_from_part.directory_name+my_copy_from_part.material_file_name;

		long buffer_object_head_last_modify_time=new File(buffer_object_head_gzip_file_name).lastModified();
		if(buffer_object_head_last_modify_time>last_modified_time) {
			if(buffer_object_head_last_modify_time>my_part.part_par.last_modified_time)
				if(buffer_object_head_last_modify_time>new File(cfp_mesh_file_name).lastModified())
					if(buffer_object_head_last_modify_time>new File(cfp_material_file_name).lastModified()){
						my_part.boftal=null;
						if(my_part.part_par.engine_boftal_flag)
							if(boftal_container!=null)
								if(buffer_object_head_last_modify_time<boftal_container.last_modify_time)
									my_part.boftal=boftal_container.search_boftal(part_temporary_file_directory);
						
						if(my_part.boftal==null) {
							file_reader fr=new file_reader(
								part_temporary_file_directory+"mesh.boftal",system_par.local_data_charset);
							my_part.boftal=new buffer_object_file_modify_time_and_length(fr);
							fr.close();
						}
						if(my_part.part_mesh==null){
							if(my_part.part_par.free_part_memory_flag)
								my_part.part_mesh=my_part.boftal.simple_part_mesh;
							else{
								exclusive_file_mutex efm=null;
								if(my_part.part_par.do_load_lock_flag)
									efm=exclusive_file_mutex.lock(lock_file_name,
										 "wait for load_mesh_and_create_buffer_object_and_material_file:	"
										+my_part.directory_name+my_part.mesh_file_name);
								my_part.part_mesh=my_part.call_part_driver_for_load_part_mesh(null,pcps,system_par,scene_par);
								if(efm!=null)
									efm.unlock();
							}
						}
						if(my_part.part_mesh!=null)
							if(my_part.part_par.free_part_memory_flag)
								my_part.part_mesh.free_memory();
						
						my_part.boftal.simple_part_mesh=null;
						
						return already_loaded_part;
					}
		}
		
		part_loader ret_val[]=already_loaded_part;
		part_loader_container_lock.lock();
		try{
			ret_val=load_routine(my_part,my_copy_from_part,
				last_modified_time,system_par,scene_par,already_loaded_part,pcps,boftal_container);
		}catch(Exception e) {
			debug_information.println("load of part_loader_container fail");
			debug_information.println(e.toString());
			e.printStackTrace();
		}
		part_loader_container_lock.unlock();
		return ret_val;
	}
}
