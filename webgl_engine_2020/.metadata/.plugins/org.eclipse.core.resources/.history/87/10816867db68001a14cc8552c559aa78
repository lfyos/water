package driver_cad;

import java.io.File;

import cadex.*;

import kernel_common_class.const_value;
import kernel_common_class.debug_information;
import kernel_file_manager.file_reader;
import kernel_file_manager.file_writer;

class cad_license_key 
{
	private static boolean has_not_done_test_flag=true,uneffective_flag=false;
	private static String error_message="";

	public static boolean test_license(String license_file_name,String target_charset)
	{
		if(has_not_done_test_flag) {
			has_not_done_test_flag=false;
			try{
	        	uneffective_flag=false;
	        	System.loadLibrary ("CadExCore");
	            System.loadLibrary ("CadExACIS");
	            System.loadLibrary ("CadExBRep");
	            System.loadLibrary ("CadExCollada");
	            System.loadLibrary ("CadExDXF");
	            System.loadLibrary ("CadExFBX");
	            System.loadLibrary ("CadExIFC");
	            System.loadLibrary ("CadExIGES");
	            System.loadLibrary ("CadExJT");
	            System.loadLibrary ("CadExOBJ");
	            System.loadLibrary ("CadExPara");
	            System.loadLibrary ("CadExRhino");
	            System.loadLibrary ("CadExSLD");
	            System.loadLibrary ("CadExSTEP");
	            System.loadLibrary ("CadExSTL");
	            System.loadLibrary ("CadExA3DS");
	            System.loadLibrary ("CadExVRML");
	            System.loadLibrary ("CadExX3D");
	        }catch (UnsatisfiedLinkError e) {
	        	uneffective_flag=true;
	        	error_message+="\nCAD Exchanger SDK does System.loadLibrary error:\t"+e.toString();
	        	debug_information.println(error_message);
	        }
			
			String license_str="";
			for(file_reader license_f=new file_reader(license_file_name,target_charset);;) {
				String str;
				if(license_f.eof()){
					license_f.close();
					break;
				}
				if((str=license_f.get_line())!=null)
					license_str+=str.trim();
			}

			if(LicenseManager.Activate(license_str))
				uneffective_flag=false;
			else {
				has_not_done_test_flag=true;
				uneffective_flag=true;
				error_message+="\nCAD Exchanger SDK license error!"; 
				debug_information.println(error_message);
			}
		}
		if(uneffective_flag)
			debug_information.println(error_message);
		return uneffective_flag;
	}
}

class material
{
	double color[],ambient[],diffuse[],specular[],emission[];
	double shininess;

	public static boolean compare(material s,material t)
	{
		for(int i=0;i<4;i++) {
			if(Math.abs(s.color[i]-t.color[i])>const_value.min_value)
				return false;
			if(Math.abs(s.ambient[i]-t.ambient[i])>const_value.min_value)
				return false;
			if(Math.abs(s.diffuse[i]-t.diffuse[i])>const_value.min_value)
				return false;
			if(Math.abs(s.specular[i]-t.specular[i])>const_value.min_value)
				return false;
			if(Math.abs(s.emission[i]-t.emission[i])>const_value.min_value)
				return false;
		}
		return (Math.abs(s.shininess-t.shininess)>const_value.min_value)?false:true;
	}
	
	public material(ModelData_Appearance ap)
	{
		color		=new double[]{0.60,0.60,0.60,1};
		ambient		=new double[]{0.25,0.25,0.25,1};
		diffuse		=new double[]{0.75,0.75,0.75,1};
		specular	=new double[]{0.75,0.75,0.75,1};
		shininess	=8;
		emission	=new double[]{0.25,0.25,0.25,1};
		
		ModelData_Color model_color=new ModelData_Color();
		if(ap.ToColor(model_color))
			if(model_color.IsValid())
				color=new double[]{model_color.R(),model_color.G(),model_color.B(),model_color.A()};

		ModelData_Material model_material=new ModelData_Material();
		if(ap.ToMaterial(model_material)){
			if((model_color=model_material.AmbientColor()).IsValid())
				ambient=new double[]{model_color.R(),model_color.G(),model_color.B(),model_color.A()};
			if((model_color=model_material.DiffuseColor()).IsValid())
				diffuse=new double[]{model_color.R(),model_color.G(),model_color.B(),model_color.A()};
			if((model_color=model_material.SpecularColor()).IsValid()) {
				specular=new double[]{model_color.R(),model_color.G(),model_color.B(),model_color.A()};
				shininess=model_material.Shininess();
/*				
				if((specular[0]*specular[0]+specular[1]*specular[1]+specular[2]*specular[2])<0.01) {
					specular=new double[]{0.5,0.5,0.5,1.0};
					shininess=8;
				}
*/				
			}
			if((model_color=model_material.EmissionColor()).IsValid())
				emission=new double[]{model_color.R(),model_color.G(),model_color.B(),model_color.A()};
		}
	}
}

class material_array
{
	private material ma[];
	public double red,green,blue,alfa;
	
	public void write_material(String file_name,String charset_name)
	{
		file_writer fw=new file_writer(file_name,charset_name);
		
		fw.begin_str	="[";
		fw.separator_str=",";
		fw.end_str		="],";
		
		fw.println("			\"material\"	:	[");
		for(int i=0,ni=ma.length;i<ni;i++) {
			
			fw.println("				{");
			fw.println("					\"ambient\"		:	",		ma[i].ambient);
			fw.println("					\"diffuse\"		:	",		ma[i].diffuse);
			fw.println("					\"specular\"		:	",	ma[i].specular);
			fw.println("					\"emission\"		:	",	ma[i].emission);
			fw.println("					\"shininess\"		:	",	ma[i].shininess);
			fw.println("				}",(i==(ni-1))?"":",");
		}
		fw.println("			]");
		
		fw.close();
	}
	private int touch_routine(ModelData_Appearance ap)
	{
		material m=new material(ap);
		for(int i=0,ni=ma.length;i<ni;i++)
			if(material.compare(ma[i],m))
				return i;
		material bak[]=ma;
		ma=new material[ma.length+1];
		for(int i=0,ni=bak.length;i<ni;i++)
			ma[i]=bak[i];
		ma[ma.length-1]=m;
		return ma.length-1;
	}
	public int touch(ModelData_Appearance ap)
	{
		int material_id=touch_routine(ap);
		red		=ma[material_id].color[0];
		green	=ma[material_id].color[1];
		blue	=ma[material_id].color[2];
		alfa	=ma[material_id].color[3];
		return material_id;
	}
	public material_array()
	{
		ma=new material[0];
	}
}

class part_exporter
{
	public static boolean do_part_export(
			ModelData_Part thePart,int part_id,file_writer part_list_fw,
			String target_directory_name,String charset_name)
	{
		ModelData_Appearance part_app=thePart.Appearance();
		
		material_array material=new material_array();
		
		ModelData_PolyRepresentation poly_rep=thePart.PolyRepresentation
						(ModelData_RepresentationMask.ModelData_RM_Poly);
        if (poly_rep.IsNull()) 
        	return false;
        
        ModelData_PolyShapeList mesh_list=poly_rep.Get();
        long face_number=mesh_list.Size();
        
        if(face_number<=0)
        	return false;
        
        String part_user_name=thePart.Name().ToUTF8().Data();
        part_user_name=part_user_name.replaceAll("[ \t\r\n]","");
        if(part_user_name.length()<=0)
        	part_user_name="null_part_user_name";
        
        String mesh_file_name		="part_"+part_id+".mesh";
        String material_file_name	="part_"+part_id+".material";
        String decription_file_name	="part_"+part_id+".decription";
        String audio_file_name		="part_"+part_id+".mp3";

        part_list_fw.println("/*	part user name				*/		",part_user_name);
        part_list_fw.println("/*	part system name			*/		","cad_part_"+part_id);
        part_list_fw.println("/*	part mesh file name			*/		",mesh_file_name);
        part_list_fw.println("/*	part material file name		*/		",material_file_name);
        part_list_fw.println("/*	part description file name	*/		",decription_file_name);
        part_list_fw.println("/*	part audio file name		*/		",audio_file_name);
        part_list_fw.println();
        
        file_writer fw=new file_writer(target_directory_name+mesh_file_name,charset_name);

        fw.println("/*	version			*/	2020.01.28");
        fw.println("/*	origin material	*/	0	0	0	0");
        fw.println("/*	body_number		*/	1");
        fw.println("/*	body  0  name   */  my_body   /*   face_number   */  ",face_number);
        
        for(int i=0;i<face_number;i++){
        	fw.println("	/* face  name   */  my_face_",i);
        	fw.println("	/* face_type   */  unknown  /*   parameter_number   */  0 /*   parameter  */ ");        	
            ModelData_PolyVertexSet poly_vertex_set=mesh_list.Access(i);
            if(poly_vertex_set.TypeId()==ModelData_IndexedTriangleSet.GetTypeId()) {
            	dump_triangle_set(ModelData_IndexedTriangleSet.Cast (poly_vertex_set),material,fw,part_app);
            	continue;
            }  
            if (poly_vertex_set.TypeId()==ModelData_PolyLineSet.GetTypeId()) {
            	dump_poly_line_set (ModelData_PolyLineSet.Cast (poly_vertex_set),material,fw,part_app);
            	continue;
            }    
            if (poly_vertex_set.TypeId()==ModelData_PolyPointSet.GetTypeId()) {
            	dump_poly_point_set (ModelData_PolyPointSet.Cast (poly_vertex_set),material,fw,part_app);
            	continue;
            }           
            fw.println("		/* face_attribute_number	*/	0");
            fw.println("		/* face_vertex_number		*/  0");
            fw.println("		/* face_normal_number		*/	0");
            fw.println("		/* face_primitive_number	*/  0");
            fw.println("		/* face_loop_number			*/	0");
        }
        
        fw.close();
        
        material.write_material(target_directory_name+material_file_name,charset_name);
        
        return true;
    }
	
	private static void dump_triangle_set (ModelData_IndexedTriangleSet theTS,
			material_array material,file_writer fw,ModelData_Appearance part_app)
    {
		boolean normal_flag	=theTS.HasNormals();
        boolean texture_flag=theTS.HasUVCoordinates();
        boolean color_flag	=theTS.HasColors();
        
		ModelData_Appearance my_app=theTS.Appearance();
		if(my_app.IsNull())
			my_app=part_app;
		int material_id=material.touch(my_app);
		
        int n=theTS.NumberOfFaces();
        
        fw.println("		/* face_attribute_number	*/	2");
        
        fw.println("		/* face_vertex_number		*/  ",3*n);
        for(int i=0,k=0;i<n;i++)
        	for(int j=0;j<3;j++){
        		ModelData_Point vertex=theTS.Coordinate (i, j);
        		fw.print  ("			/* face_vertex  ",k++);
        		fw.print  ("  is  */  ",vertex.X());
        		fw.print  ("  ",		vertex.Y());
        		fw.print  ("  ",		vertex.Z());
        		fw.println("  1.0");
        	}
        if (normal_flag) {
        	fw.println("		/* face_normal_number		*/  ",3*n);
        	for (int i=0,k=0;i<n;i++)
        		for(int j=0;j<3;j++){
            		ModelData_Vectorf normal=theTS.VertexNormal (i, j);
            		fw.print  ("			/* face_normal  ",k++);
            		fw.print  ("  is  */  ",normal.X());
            		fw.print  ("  ",		normal.Y());
            		fw.print  ("  ",		normal.Z());
            		fw.println("  1.0");
            	}
        }else {
        	fw.println("		/* face_normal_number		*/	1");
        	fw.println("			/* face_normal  0  is  */	0	0	0	1");
        }
        if(texture_flag) {
        	fw.println("		/* face_texture_number		*/  ",3*n);
        	for (int i=0,k=0;i<n;i++)
        		for(int j=0;j<3;j++){
            		ModelData_Point2d texture = theTS.UVCoordinate (i, j);
            		fw.print  ("			/* face_texture  ",k++);
            		fw.print  ("  is  */  ",texture.X());
            		fw.print  ("  ",		texture.Y());
            		fw.println("  0	1");
            	}
        }else {
        	fw.println("		/* face_texture_number		*/	1");
        	fw.println("			/* face_texture  0  is  */	0	0	0	1");
        }
        if (color_flag) {
        	fw.println("		/* face_color_number		*/	",3*n);
        	for (int i=0,k=0;i<n;i++)
        		for(int j=0;j<3;j++){
            		ModelData_Color color = theTS.VertexColor (i, j);
            		fw.print  ("			/* face_color  ",k++);
            		fw.print  ("  is  */  ",color.R());
            		fw.print  ("  ",		color.G());
            		fw.print  ("  ",		color.B());
            		fw.println("  ",		color.A());
            	}
        }else{
        	fw.println("		/* face_color_number		*/	1");
        	fw.print  ("			/* face_color  0  is  */	",	material.red);
        	fw.print  ("  ",										material.green);
    		fw.print  ("  ",										material.blue);
    		fw.println("  ",										material.alfa);
        }

        fw.println("		/* face_primitive_number  */  ",n);

        for(int i=0;i<n;i++) {
        	String str="			/* face_primitive  "+i+"	";

        	fw.print  (str);
        	fw.print  ("material		*/	",	normal_flag	?"1":"-1");
        	fw.print  ("	",					texture_flag?"1":"-1");
        	fw.print  ("	",					color_flag	?"1":"-1");
        	fw.println("	",					material_id);
        	
        	fw.print  (str);	fw.println("vertex_index	*/	",(3*i)+"	"+(3*i+1)+"	"+(3*i+2)+"	-1");
 
        	if (normal_flag)
        		{fw.print  (str);fw.println("normal_index	*/	",(3*i)+"	"+(3*i+1)+"	"+(3*i+2)+"	-1");}
        	else
        		{fw.print  (str);fw.println("normal_index	*/	0	0	0	-1");}
        	
        	if (texture_flag)
        		{fw.print  (str);fw.println("texture_index	*/	",(3*i)+"	"+(3*i+1)+"	"+(3*i+2)+"	-1");}
        	else
        		{fw.print  (str);fw.println("texture_index	*/	0	0	0	-1");}
        	
        	if (color_flag)
        		{fw.print  (str);fw.println("color_index		*/	",(3*i)+"	"+(3*i+1)+"	"+(3*i+2)+"	-1");}
        	else
        		{fw.print  (str);fw.println("color_index		*/	0	0	0	-1");}
        }
        
        fw.println();
        fw.println("		/* face_loop_number   */ 0");
        fw.println();
        
        return;
    }
	
	private static void dump_poly_line_set (ModelData_PolyLineSet thePLS,
			material_array material,file_writer fw,ModelData_Appearance part_app)
    {
		ModelData_Appearance my_app=thePLS.Appearance();
		if(my_app.IsNull())
			my_app=part_app;
		int material_id=material.touch(my_app);
		
        int edge_number=thePLS.NumberOfPolyLines();
        
		fw.println("		/*	face_attribute_number	*/	0");
    	fw.println("		/*	face_vertex_number		*/  0");
    	fw.println("		/*	face_normal_number		*/	0");
    	fw.println("		/*	face_primitive_number	*/  0");
    	fw.println("		/*	face_loop_number		*/	1");
    	
    	fw.println("		/*	NO. 0 loop edge number	*/	",edge_number);
    	
    	for(int i=0;i<edge_number;i++) {
    		int vertex_number=thePLS.NumberOfVertices (i);
	    	fw.println("		/*	curve type   			*/  unknown");
	    	fw.println("		/*	parameter number		*/  0  /*  parameter  */");
	    	
	    	fw.print  ("		/*	parameter_point_material  */  ",material.red);
	    	fw.print  ("	",material.green);
	    	fw.print  ("	",material.blue);
	    	fw.println("	",material_id);

	    	fw.println("			start_not_effective");
	    	fw.println("			end_not_effective");
	    	fw.println("		/*	vertex number	*/	",vertex_number);
	    	for(int j=0;j<vertex_number;j++) {
	    		ModelData_Point p=thePLS.Coordinate (i,j);
	    		
                fw.print  ("		/*	NO.",j);
                fw.print  ("	vertex location  */     ",p.X());
                fw.print  ("	",p.Y());
                fw.print  ("	",p.Z());
                fw.print  ("	1   /*  tessellation_material  */  ",material.red);
    	    	fw.print  ("	",material.green);
    	    	fw.print  ("	",material.blue);
    	    	fw.println("	",material_id);
	    	}
    	}
    	fw.println();
    }
	private static void dump_poly_point_set(ModelData_PolyPointSet thePS,
			material_array material,file_writer fw,ModelData_Appearance part_app)
    {
		ModelData_Appearance my_app=thePS.Appearance();
		if(my_app.IsNull())
			my_app=part_app;
		
		int material_id=material.touch(my_app);
		int point_number=thePS.NumberOfVertices();
		
		fw.println("		/*	face_attribute_number	*/	0");
    	fw.println("		/*	face_vertex_number		*/  0");
    	fw.println("		/*	face_normal_number		*/	0");
    	fw.println("		/*	face_primitive_number	*/  0");
    	fw.println("		/*	face_loop_number		*/	1");
    	
    	fw.println("		/*	NO. 0 loop edge number	*/	1");
    	fw.println("		/*	curve type   			*/  point");
    	fw.println("		/*	parameter number		*/  0  /*  parameter  */");
    	
    	fw.print  ("		/*	parameter_point_material  */	",material.red);
    	fw.print  ("	",material.green);
    	fw.print  ("	",material.blue);
    	fw.println("	",material_id);

    	fw.println("			start_not_effective");
    	fw.println("			end_not_effective");
    	fw.println("		/*	vertex number	*/	",point_number);
    	
    	for(int i=0;i<point_number;i++) {
    		ModelData_Point p = thePS.Coordinate (i);
    		
    		fw.print  ("		/*	NO.",i);
    		fw.print  ("	vertex location  */     ",p.X());
    		fw.print  ("	",p.Y());
    		fw.print  ("	",p.Z());
    		fw.print  ("	1   /*  tessellation_material  */	",material.red);
        	fw.print  ("	",material.green);
        	fw.print  ("	",material.blue);
        	fw.println("	",material_id);
    	}
    	fw.println();
    }
}

class part_collector
{
	public ModelData_Part part_array[];
	public int number_array[],current_id;
	
	public part_collector()
	{
		part_array=new ModelData_Part[0];
		number_array=new int[0];
		
		current_id=0;
	}
	public int touch(ModelData_Part my_part)
	{		
		for(int i=0,ni=part_array.length;i<ni;i++)
			if(part_array[i].equals(my_part)) {
				current_id=i;
				return (number_array[i]++);
			}
		
		ModelData_Part bak_part[]=part_array;
		int bak_number[]=number_array;
		part_array=new ModelData_Part[part_array.length+1];
		number_array=new int[number_array.length+1];
		
		for(int i=0,ni=bak_part.length;i<ni;i++) {
			part_array[i]=bak_part[i];
			number_array[i]=bak_number[i];
		}
		part_array[part_array.length-1]=my_part;
		number_array[number_array.length-1]=1;
		current_id=part_array.length-1;
		
		return 0;
	}
}

class name_collector
{
	public String name_array[];
	public int number_array[],current_id;
	
	public name_collector()
	{
		name_array=new String[0];
		number_array=new int[0];
		
		current_id=0;
	}
	public int touch(String my_name)
	{		
		for(int i=0,ni=name_array.length;i<ni;i++)
			if(name_array[i].compareTo(my_name)==0) {
				current_id=i;
				return (number_array[i]++);
			}
		
		String bak_name[]=name_array;
		int bak_number[]=number_array;
		name_array=new String[name_array.length+1];
		number_array=new int[number_array.length+1];
		
		for(int i=0,ni=bak_name.length;i<ni;i++) {
			name_array[i]=bak_name[i];
			number_array[i]=bak_number[i];
		}
		name_array[name_array.length-1]=my_name;
		number_array[number_array.length-1]=1;
		current_id=name_array.length-1;
		
		return 0;
	}
}
class assemble_tree_node
{
	public String component_name,part_name;
	public double matrix_data[];
	public assemble_tree_node parent,children[];
	
	public assemble_tree_node(double my_matrix_data[],assemble_tree_node my_parent)
	{
		matrix_data=my_matrix_data;
		component_name=null;
		part_name=null;
		parent=my_parent;
		children=new assemble_tree_node[0];
	}
	public int display(file_writer fw,
			name_collector component_name_collector,
			String pre_str,int create_component_number)
	{
		String str;
		
		parent=null;
		
		if((str=component_name)==null)
			str="NULL_component_name";
		else 
			str=str.replaceAll("[ \t\r\n]","");
		if(str.length()<=0)
			str="zero_length_component_name";
		fw.println(pre_str,str+"_"+component_name_collector.touch(str));
		
		if((str=part_name)==null)
			str="NULL_part_name";
		else 
			str=str.replaceAll("[ \t\r\n]","");
		if(str.length()<=0)
			str="zero_length_part_name";
		fw.println(pre_str,str);
		
		fw.print  (pre_str);
		for(int i=0;i<16;i++)
			fw.print(Double.toString(matrix_data[i]),"\t");
		fw.println();
		fw.println(pre_str,children.length);
		
		create_component_number++;
		
		pre_str+="	";
		for(int i=0,ni=children.length;i<ni;i++)
			create_component_number=children[i].display(
				fw,component_name_collector,pre_str,create_component_number);
		
		return create_component_number;
	}
}

class component_visitor extends ModelData_Model.VoidElementVisitor
{
	public assemble_tree_node t;

	public part_collector collect_part;
	
	public int id,instance_number;

	private String target_directory_name,charset_name;
	private file_writer part_list_fw;
	
	public component_visitor(String my_target_directory_name,String my_charset_name)
    {
		t=new assemble_tree_node(
				new double[] {
						1,0,0,0,
						0,1,0,0,
						0,0,1,0,
						0,0,0,1
				},null);
		t.component_name="cad_root_component";
		t.part_name="cad_root_part";
		
		id=0;
		instance_number=0;
		
		collect_part=new part_collector();
		
		target_directory_name=my_target_directory_name;
		charset_name=my_charset_name;
		
		part_list_fw=new file_writer(target_directory_name+"part.list",charset_name);
    }
	public void Apply (ModelData_Part thePart)
    {
		debug_information.println(
				 "Total part_number:"+collect_part.part_array.length
				+",Part Apply:"+thePart.Name().ToUTF8().Data().toString());
		if(collect_part.touch(thePart)==0)
			part_exporter.do_part_export(thePart,
				collect_part.current_id,part_list_fw,target_directory_name,charset_name);
		t.part_name="cad_part_"+(collect_part.current_id);
    }
    public boolean VisitEnter (ModelData_Instance theInstance)
    {
    	debug_information.println(
    			 "Total instance number:"+(instance_number++)
    			+",Instance VisitEnter:"+theInstance.Name().ToUTF8().Data().toString());
    	
    	double matrix_data[];
    	if(theInstance.HasTransformation()) {
    		ModelData_Transformation p=theInstance.Transformation();
    		matrix_data=new double[] {
					p.Data(0,0),p.Data(1,0),p.Data(2,0),0,
					p.Data(0,1),p.Data(1,1),p.Data(2,1),0,
					p.Data(0,2),p.Data(1,2),p.Data(2,2),0,
					p.Data(0,3),p.Data(1,3),p.Data(2,3),1
			};
    	}else
    		matrix_data=new double[] {
						1,0,0,0,
						0,1,0,0,
						0,0,1,0,
						0,0,0,1
				};
    	assemble_tree_node this_tree_node=new assemble_tree_node(matrix_data,t);
    	
    	assemble_tree_node bak[]=t.children;
    	t.children=new assemble_tree_node[bak.length+1];
    	for(int i=0,ni=bak.length;i<ni;i++)
    		t.children[i]=bak[i];
    	t.children[t.children.length-1]=this_tree_node;
    	t=this_tree_node;
        return true;
    }
    public void VisitLeave (ModelData_Instance theInstance)
    {
    	debug_information.println("Instance VisitLeave:"+theInstance.Name().ToUTF8().Data().toString());
    	
    	if((t.component_name=theInstance.Name().ToUTF8().Data()).length()<=0) {
    		ModelData_SceneGraphElement sge=theInstance.Reference();
    		if((t.component_name=sge.Name().ToUTF8().Data()).length()<=0)
    			t.component_name="unknown_component_name"+"-"+(id++);
    	}
    	assemble_tree_node parent_tree_node=t.parent;
    	t.parent=null;
    	t=parent_tree_node;
    }
    public boolean create_file()
    {
    	part_list_fw.close();
    	
    	file_writer fw=new file_writer(target_directory_name+"assemble.assemble",charset_name);
    	fw.println("/*");
    	
    	int part_component_number=0;
    	for(int i=0,ni=collect_part.part_array.length;i<ni;i++) 
    		part_component_number+=collect_part.number_array[i];

    	fw.println("		part number:",collect_part.part_array.length);
    	fw.println("		part_component_number:",part_component_number);
    	fw.println();

		for(int i=0,ni=collect_part.part_array.length;i<ni;i++) {
			fw.print  ("		",collect_part.number_array[i]);
			fw.println("		",collect_part.part_array[i].Name().ToUTF8().Data());
		}

    	fw.println("*/");
    	fw.println();
    	fw.println();
    	
    	int ret_val;
    	if(t.children.length>0)
    		ret_val=t.display(fw,new name_collector(),"",0)+collect_part.part_array.length;
    	else {
    		ret_val=collect_part.part_array.length;
    		
    		fw.println("cad_root_component");
    		fw.println("cad_root_part");
    		fw.println("1.0	0.0	0.0	0.0		0.0	1.0	0.0	0.0		0.0	0.0	1.0	0.0		0.0	0.0	0.0	1.0");
    		fw.println(ret_val);
    		
    		for(int i=0;i<ret_val;i++) {
    			fw.println();
    			fw.println("		cad_component_",i);
    			fw.println("		cad_part_",i);
    			fw.println("		1.0	0.0	0.0	0.0		0.0	1.0	0.0	0.0		0.0	0.0	1.0	0.0		0.0	0.0	0.0	1.0");
    			fw.println("		",0);
    		}
    		fw.println();
    	}
        fw.close();
        return (ret_val>0);
    }
}
public class converter
{
	private static Base_Reader get_reader(String type_name)
	{
		switch(type_name.toLowerCase()){
		default:
			return null;
		case "igs":
		case "iges":
			return new cadex.IGES_Reader();
		case "stp":
		case "step":
			cadex.STEP_Reader my_reader = new cadex.STEP_Reader();
			cadex.STEP_ReaderParameters reader_parameter = my_reader.Parameters();
	        reader_parameter.SetPreferredBRepRepresentationType(cadex.STEP_ReaderParameters.BRepRepresentationType.AdvancedBRep);
	        return my_reader;
		case "sat":
		case "sab":
			return new cadex.ACIS_Reader();
		case "x_t":
		case "x_b":
		case "xmt_txt":
		case "xmt_bin": 
		case "xmp_txt":
		case "xmp_bin":
			return new cadex.Para_Reader();
		case "jt":
			return new cadex.JT_Reader();
		case "sldprt":
		case "sldasm":
			return new cadex.SLD_Reader();
		case "ifc":
			return new cadex.IFC_Reader();
		case "3dm":
			return new cadex.Rhino_Reader();
		case "obj":
			return new cadex.OBJ_Reader();
		case "stl":
			return new cadex.STL_Reader();
		case "wrl":
			return new cadex.VRML_Reader();
		case "x3d":	
			return new cadex.X3D_Reader();
		case "fbx":
			return new cadex.FBX_Reader();
		case "dxf":
			return new cadex.DXF_Reader();
		case "dae":
			return new cadex.Collada_Reader();
		case "3ds":
			return new cadex.A3DS_Reader();
		case "brep":
			return new cadex.BRep_Reader();
		}
	}
	private static boolean do_convert(
			String source_directory_name,String source_file_name,
			double chordal_deflection,double angular_deflection,
			String target_directory_name,String license_file_name,
			String target_charset)
	{
		debug_information.println("CAD Exchanger SDK begin convertion",",directory_name is "+source_directory_name);
		debug_information.println("CAD Exchanger SDK begin convertion",",file_name is "+source_file_name);
		
		if(cad_license_key.test_license(license_file_name,target_charset)) {
			debug_information.println("CAD Exchanger SDK convertion terminated:","license error. file_name is "+source_file_name);
			return true;
		}
		
		int index_id;
		if((index_id=(source_directory_name+source_file_name).lastIndexOf('.'))<0) {
			debug_information.println("CAD Exchanger SDK convertion terminated:",
					"unrecognized file type,file name is "+source_file_name);
			return true;
		}
		
		File f=new File(source_directory_name+source_file_name);
		if(!(f.exists())) {
			debug_information.println("CAD Exchanger SDK convertion terminated:",
					"3D source file NOT exist,file name is "+source_file_name);
			return true;
		}
		if(!(f.isFile())) {
			debug_information.println("CAD Exchanger SDK convertion terminated:",
					"3D source file NOT regular file,file name is "+source_file_name);
			return true;
		}

		Base_Reader my_reader;
		if((my_reader=get_reader((source_directory_name+source_file_name).substring(index_id+1)))==null) {
			debug_information.println("CAD Exchanger SDK convertion terminated:",
					"CAD Exchanger SDK creates reader fail,file name is"+source_file_name);
			return true;
		}
		
		debug_information.println("CAD Exchanger SDK begin reading file,file name is "+source_file_name);
		if (!my_reader.ReadFile(new Base_UTF16String (source_directory_name+source_file_name))) {
        	debug_information.println("CAD Exchanger SDK convertion terminated:",
        			"CAD Exchanger SDK failed to read file. file name is "+source_file_name);
        	return true;
        }

		debug_information.println("CAD Exchanger SDK begin transfering,file name is "+source_file_name);
		ModelData_Model my_model=new ModelData_Model();
        if (!my_reader.Transfer (my_model)) {
        	debug_information.println("CAD Exchanger SDK convertion terminated:",
        			"CAD Exchanger SDK failed to transfer,file name is	"+source_file_name);
        	return true;
        }

        debug_information.println("CAD Exchanger SDK begin creating mesh,file name is "+source_file_name);
        ModelAlgo_BRepMesherParameters my_parameter=new ModelAlgo_BRepMesherParameters();
        
        if((chordal_deflection>0.0)&&(angular_deflection>0.0)){
        	my_parameter.SetChordalDeflection(Math.abs(chordal_deflection));
        	my_parameter.SetAngularDeflection(Math.abs(angular_deflection));
        }else
        	switch((int)(Math.round((chordal_deflection<angular_deflection)?chordal_deflection:angular_deflection))){
        	case 0:
        		my_parameter.SetGranularity(ModelAlgo_BRepMesherParameters.Granularity.Fine);
        		break;
        	case -1:
        		my_parameter.SetGranularity(ModelAlgo_BRepMesherParameters.Granularity.Medium);
        		break;
        	case -2:
        	default:
        		my_parameter.SetGranularity(ModelAlgo_BRepMesherParameters.Granularity.Coarse);
        		break;
        	}
        ModelAlgo_BRepMesher my_mesher=new ModelAlgo_BRepMesher(my_parameter);
        my_mesher.Compute (my_model);
    
        debug_information.println("CAD Exchanger SDK begin traversing scene tree,file name is "+source_file_name);
        component_visitor cv=new component_visitor(target_directory_name,target_charset);
        my_model.Accept(cv);
        
        debug_information.println("CAD Exchanger SDK begin creating file,file name is "+source_file_name);
        
        if(cv.create_file()) {
	        (new file_writer(target_directory_name+"token.txt",null)).close();
			debug_information.println("CAD Exchanger SDK convertion success,file name is "+source_file_name);
			return false;
        }else {
        	file_writer.file_delete(target_directory_name+"token.txt");
			debug_information.println("CAD Exchanger SDK convertion fail,file name is "+source_file_name);
			return true;
        }
	}
	
	public static void main(String args[])
	{		
		String source_directory_name=args[0];
		String source_file_name		=args[1];
		String target_directory_name=args[2];
		String target_charset		=args[3];
		double chordal_deflection	=Double.parseDouble(args[4]);
		double angular_deflection	=Double.parseDouble(args[5]);
		String license_file_name	=args[6];
/*
		String source_directory_name="D:\\软件后备\\模型文件\\成广庆\\Tekla+Test\\";
		String source_file_name		="out.ifc";
		String target_directory_name="c:\\temp\\";
		String target_charset		="GBK";
		double chordal_deflection	=0;
		double angular_deflection	=0;
		String license_file_name	="d:\\cad\\license.txt";
*/		
		do_convert(source_directory_name,source_file_name,
				chordal_deflection,angular_deflection,
				target_directory_name,license_file_name,
				target_charset);
	}
}